# @epdoc/launchgen

Generate or update a `launch.json` file for use with VSCode. This script is designed to work with both Deno and Node.js
projects, automatically detecting the runtime and generating the appropriate launch configurations.

## Features

- **Automatic Runtime Detection:** Detects whether you are using Deno or Node.js based on the presence of `deno.json` or
  `package.json`.
- **Test File Discovery:** Walks the project folder and adds launch configurations for each test file found (e.g.,
  `*.test.ts`, `*.run.ts`, `*.test.js`, `*.run.js`).
- **Customizable Configurations:** Add custom launch configurations using a `launch.config.json` file.
- **Monorepo Support:** Works with monorepos by reading the `workspace` or `workspaces` property in your `deno.json` or
  `package.json`.
- **Preserves Manual Configurations:** Any existing launch configurations that were not generated by this script will be
  preserved.
- **Extensible:** The `LaunchGenerator` class is designed to be extended, allowing you to customize its behavior.

## Requirements

- Deno 1.0+ or Node.js 12+
- A VSCode project (`.vscode` folder in the project root).

## Usage

### Direct Execution

Because the script includes a shebang, you can execute it directly from your terminal after making it executable:

```bash
chmod +x launchgen.ts
./launchgen.ts
```

Alternatively, you can use `deno run`:

```bash
deno run -A launchgen.ts
```

### As a Module

You can also import the `LaunchGenerator` class into your own scripts to extend its functionality or integrate it into
other workflows.

```typescript
import { LaunchGenerator } from './launchgen.ts';

const projectRoot = Deno.cwd();
const generator = new LaunchGenerator(projectRoot);
await generator.run();
```

## Configuration

The script works out of the box for most projects, but you can create a `launch.config.json` file in your project root
for more advanced configurations.

### `deno.json`

You can control which files are included and excluded from the test search by using the `tests` object in your
`deno.json` file. Note that the `tests` entry is a standard feature of `deno.json` and may be used by other Deno tools.

**Example `deno.json`:**

```json
{
  "tests": {
    "include": ["src", "tests"],
    "exclude": ["src/ignore", "tests/data"]
  }
}
```

- `tests.include`: An array of paths to include in the search for test files. If not specified, the script will use the
  `workspace` or `workspaces` property, or default to the project root.
- `tests.exclude`: An array of paths to exclude from the search. These can be files or directories, and glob patterns
  are supported. By default, all hidden files and directories (those starting with a `.`) are excluded.

### `launch.config.json`

This file allows you to define global settings, custom arguments for auto-discovered tests, and custom launch configuration groups.

**Example `launch.config.json`:**

```json
{
  "port": 9230,
  "console": "internalConsole",
  "tests": {
    "runtimeArgs": ["--check"]
  },
  "groups": [
    {
      "program": "src/main.ts",
      "runtimeArgs": ["run", "--inspect-brk", "-A"],
      "scriptArgs": ["--some-default-arg"],
      "scripts": [
        "",
        "-h",
        "--verbose"
      ]
    }
  ]
}
```

**Global Settings:**

- `port`: The port to use for debugging. Defaults to `9229`.
- `console`: The type of console to use. Can be `internalConsole`, `integratedTerminal`, or `externalTerminal`. Defaults to `integratedTerminal`.

**Auto-Discovered Test Settings (`tests`):**

- `runtimeArgs`: An array of arguments to be passed to the runtime for all auto-discovered test files. These arguments are appended to the default arguments. This is useful for applying a consistent set of flags (e.g., `--check`) across all your tests.

**Custom Group Settings (`groups`):**

Use groups when you need to manually define a launch configuration for a specific executable or create multiple launch configurations for a single script with different arguments.

- `program`: The path to the script to be executed.
- `runtimeArgs`: An array of arguments to be passed to the runtime (`deno` or `node`). For Deno, this is where you would
  put permissions like `-A` or `--allow-net`. For Node, you might include flags like `--experimental-modules`.
- `scriptArgs`: An array of default arguments to be passed to the script itself.
- `scripts`: An array of additional arguments to be passed to the script. A separate launch configuration will be
  created for each entry in this array.

### Default Arguments

The final `runtimeArgs` for an auto-discovered test file is a combination of the script-specific defaults and the global arguments defined in `launch.config.json`.

The arguments from `tests.runtimeArgs` are always added after the default arguments.

- **Deno:** When a `*.test.ts` or `*.run.ts` file is found, the script will generate a launch configuration with `runtimeArgs` set to `["test", "--inspect-brk", "-A", "<path_to_file>", ...tests.runtimeArgs]`.
- **Node.js:** When a `*.test.js` or `*.run.js` file is found, the script will generate a launch configuration with `runtimeArgs` set to `["<path_to_file>", ...tests.runtimeArgs]`.

## Extending Launchgen

The `LaunchGenerator` class is designed to be extended. The following methods are `protected` and can be overridden in a
subclass:

- `detectRuntime()`
- `loadConfigs()`
- `filterExisting()`
- `addWorkspaceFiles()`
- `addCustomGroups()`
- `writeLaunchJson()`
- `addTest()`
- `isGenerated()`

This allows you to customize the behavior of the script to fit your specific needs.

## How it Works

- The script starts by looking for a `.vscode` folder to find the project root.
- It then checks for the presence of `deno.json` or `package.json` to determine the runtime.
- It reads configuration from `deno.json`, `package.json`, and `launch.config.json` (if they exist).
- It reads the existing `launch.json` file (if it exists) and filters out any previously generated configurations.
- It walks the workspace directories, adhering to the `tests` entries in `deno.json`, and adds launch configurations for any test or run files it finds. Any global test arguments from `launch.config.json` are applied here.
- It adds any custom launch configurations defined in the `groups` section of `launch.config.json`.
- Finally, it writes the updated configurations back to the `launch.json` file.

## License

MIT